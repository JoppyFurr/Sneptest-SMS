#include <stdbool.h>
#include <stdint.h>
#include "SMSlib.h"

const uint32_t patterns[] = {

    /* Public-domain 8x8 font from https://github.com/dhepper/font8x8 */

    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  /* U+0020 (space) */
    0x18, 0x3c, 0x3c, 0x18, 0x18, 0x00, 0x18, 0x00,  /* U+0021 (!) */
    0x6c, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  /* U+0022 (") */
    0x6c, 0x6c, 0xfe, 0x6c, 0xfe, 0x6c, 0x6c, 0x00,  /* U+0023 (#) */
    0x30, 0x7c, 0xc0, 0x78, 0x0c, 0xf8, 0x30, 0x00,  /* U+0024 ($) */
    0x00, 0xc6, 0xcc, 0x18, 0x30, 0x66, 0xc6, 0x00,  /* U+0025 (%) */
    0x38, 0x6c, 0x38, 0x76, 0xdc, 0xcc, 0x76, 0x00,  /* U+0026 (&) */
    0x60, 0x60, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00,  /* U+0027 (') */
    0x18, 0x30, 0x60, 0x60, 0x60, 0x30, 0x18, 0x00,  /* U+0028 (() */
    0x60, 0x30, 0x18, 0x18, 0x18, 0x30, 0x60, 0x00,  /* U+0029 ()) */
    0x00, 0x66, 0x3c, 0xff, 0x3c, 0x66, 0x00, 0x00,  /* U+002A (*) */
    0x00, 0x30, 0x30, 0xfc, 0x30, 0x30, 0x00, 0x00,  /* U+002B (+) */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x60,  /* U+002C (,) */
    0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00,  /* U+002D (-) */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00,  /* U+002E (.) */
    0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x00,  /* U+002F (/) */
    0x7c, 0xc6, 0xce, 0xde, 0xf6, 0xe6, 0x7c, 0x00,  /* U+0030 (0) */
    0x30, 0x70, 0x30, 0x30, 0x30, 0x30, 0xfc, 0x00,  /* U+0031 (1) */
    0x78, 0xcc, 0x0c, 0x38, 0x60, 0xcc, 0xfc, 0x00,  /* U+0032 (2) */
    0x78, 0xcc, 0x0c, 0x38, 0x0c, 0xcc, 0x78, 0x00,  /* U+0033 (3) */
    0x1c, 0x3c, 0x6c, 0xcc, 0xfe, 0x0c, 0x1e, 0x00,  /* U+0034 (4) */
    0xfc, 0xc0, 0xf8, 0x0c, 0x0c, 0xcc, 0x78, 0x00,  /* U+0035 (5) */
    0x38, 0x60, 0xc0, 0xf8, 0xcc, 0xcc, 0x78, 0x00,  /* U+0036 (6) */
    0xfc, 0xcc, 0x0c, 0x18, 0x30, 0x30, 0x30, 0x00,  /* U+0037 (7) */
    0x78, 0xcc, 0xcc, 0x78, 0xcc, 0xcc, 0x78, 0x00,  /* U+0038 (8) */
    0x78, 0xcc, 0xcc, 0x7c, 0x0c, 0x18, 0x70, 0x00,  /* U+0039 (9) */
    0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00,  /* U+003A (:) */
    0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x60,  /* U+003B (;) */
    0x18, 0x30, 0x60, 0xc0, 0x60, 0x30, 0x18, 0x00,  /* U+003C (<) */
    0x00, 0x00, 0xfc, 0x00, 0x00, 0xfc, 0x00, 0x00,  /* U+003D (=) */
    0x60, 0x30, 0x18, 0x0c, 0x18, 0x30, 0x60, 0x00,  /* U+003E (>) */
    0x78, 0xcc, 0x0c, 0x18, 0x30, 0x00, 0x30, 0x00,  /* U+003F (?) */
    0x7c, 0xc6, 0xde, 0xde, 0xde, 0xc0, 0x78, 0x00,  /* U+0040 (@) */
    0x30, 0x78, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0x00,  /* U+0041 (A) */
    0xfc, 0x66, 0x66, 0x7c, 0x66, 0x66, 0xfc, 0x00,  /* U+0042 (B) */
    0x3c, 0x66, 0xc0, 0xc0, 0xc0, 0x66, 0x3c, 0x00,  /* U+0043 (C) */
    0xf8, 0x6c, 0x66, 0x66, 0x66, 0x6c, 0xf8, 0x00,  /* U+0044 (D) */
    0xfe, 0x62, 0x68, 0x78, 0x68, 0x62, 0xfe, 0x00,  /* U+0045 (E) */
    0xfe, 0x62, 0x68, 0x78, 0x68, 0x60, 0xf0, 0x00,  /* U+0046 (F) */
    0x3c, 0x66, 0xc0, 0xc0, 0xce, 0x66, 0x3e, 0x00,  /* U+0047 (G) */
    0xcc, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0xcc, 0x00,  /* U+0048 (H) */
    0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00,  /* U+0049 (I) */
    0x1e, 0x0c, 0x0c, 0x0c, 0xcc, 0xcc, 0x78, 0x00,  /* U+004A (J) */
    0xe6, 0x66, 0x6c, 0x78, 0x6c, 0x66, 0xe6, 0x00,  /* U+004B (K) */
    0xf0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xfe, 0x00,  /* U+004C (L) */
    0xc6, 0xee, 0xfe, 0xfe, 0xd6, 0xc6, 0xc6, 0x00,  /* U+004D (M) */
    0xc6, 0xe6, 0xf6, 0xde, 0xce, 0xc6, 0xc6, 0x00,  /* U+004E (N) */
    0x38, 0x6c, 0xc6, 0xc6, 0xc6, 0x6c, 0x38, 0x00,  /* U+004F (O) */
    0xfc, 0x66, 0x66, 0x7c, 0x60, 0x60, 0xf0, 0x00,  /* U+0050 (P) */
    0x78, 0xcc, 0xcc, 0xcc, 0xdc, 0x78, 0x1c, 0x00,  /* U+0051 (Q) */
    0xfc, 0x66, 0x66, 0x7c, 0x6c, 0x66, 0xe6, 0x00,  /* U+0052 (R) */
    0x78, 0xcc, 0xe0, 0x70, 0x1c, 0xcc, 0x78, 0x00,  /* U+0053 (S) */
    0xfc, 0xb4, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00,  /* U+0054 (T) */
    0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xfc, 0x00,  /* U+0055 (U) */
    0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x00,  /* U+0056 (V) */
    0xc6, 0xc6, 0xc6, 0xd6, 0xfe, 0xee, 0xc6, 0x00,  /* U+0057 (W) */
    0xc6, 0xc6, 0x6c, 0x38, 0x38, 0x6c, 0xc6, 0x00,  /* U+0058 (X) */
    0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x30, 0x78, 0x00,  /* U+0059 (Y) */
    0xfe, 0xc6, 0x8c, 0x18, 0x32, 0x66, 0xfe, 0x00,  /* U+005A (Z) */
};

void draw_string (int x, int y, char *string)
{
    uint16_t name_table[32] = { 0 };
    int count = 0;

    while (string[count])
    {
        if      (string[count] >= ' ' && string[count] <= 'Z')
        {
            name_table[count] = string[count] - ' ';
        }
        /* Default to space */
        else
        {
            name_table[count] = 0;
        }

        count++;
    }

    SMS_loadTileMapArea (x, y, name_table, count, 1);
}

void clear_screen (void)
{
    uint16_t name_table[32] = { 0 };
    for (int i = 0; i < 28; i++)
    {
        SMS_loadTileMapArea (0, i, name_table, 32, 1);
    }

    draw_string (1,  0,  "SNEP TEST SMS");
    draw_string (0,  1, "---------------");
    draw_string (7, 23, "1: BACK, 2: SELECT");
}

void font_test (void)
{
    clear_screen ();
    draw_string (1, 3,  "FONT:");
    draw_string (4, 6,  "A B C D E F G H I J K L");
    draw_string (4, 8,  "M N O P Q R S T U V W X");
    draw_string (4, 10,  "Y Z");

    draw_string (4, 13, "0 1 2 3 4 5 6 7 8 9");

    draw_string (4, 16, "! \" # $ % & ' ( ) * + ,");
    draw_string (4, 18, "- . / : ; < = > ? @");

    while (true)
    {
        unsigned int pressed;
        SMS_waitForVBlank ();

        pressed = SMS_getKeysPressed ();
        if (pressed & PORT_A_KEY_1)
            break;
    }
}

void main (void)
{
    uint16_t cursor = 0;
    bool first_draw = true;

    SMS_setBackdropColor (0);
    SMS_setBGPaletteColor (0, 0x01); /* Dark red at index 0 (background) */
    SMS_setBGPaletteColor (1, 0x3f); /* White at index 1    (font)       */
    SMS_setBGPaletteColor (2, 0x00); /* Black   at index 0 */

    SMS_loadTiles (patterns, 0, sizeof (patterns));

    SMS_displayOn ();

menu_start:

    clear_screen ();
    draw_string ( 3,  3,  "TEST ROM FOR SMS EMULATORS");
    draw_string ( 8,  7,  "FONT");
    draw_string ( 8,  9,  "YIFF");
    draw_string ( 8, 11,  "POOLTOYS");


    while (true)
    {
        unsigned int pressed;
        SMS_waitForVBlank ();

        /* Clear cursor */
        draw_string (5, 7 + (cursor << 1), "  ");

        pressed = SMS_getKeysPressed ();
        if (pressed & PORT_A_KEY_UP)
        {
            if (--cursor > 3)
                cursor = 0;
        }
        else if (pressed & PORT_A_KEY_DOWN)
        {
            if (++cursor > 2)
                cursor = 2;
        }
        else if (pressed & PORT_A_KEY_2)
        {
            switch (cursor)
            {
                case 0:
                    font_test ();
                    goto menu_start;

                default: break;
            }
        }

        /* Draw cursor */
        draw_string (5, 7 + (cursor << 1), "->");

    }
}
